
services:
  # 1. 后端 FastAPI 服务
  backend:
    build: ./backend  # 使用 backend 目录下的 Dockerfile 构建镜像
    container_name: kb_backend
    env_file:
      - ./backend/.env  # 加载环境变量
    ports:
      - "8888:8000"  # 将主机的 8888 端口映射到容器的 8000 端口
    volumes:
      - ./backend/app:/app  # 将本地代码挂载到容器，方便热重载
    depends_on:
      - db          # 确保在后端启动前，数据库服务已启动
      - ragflow     # 确保在后端启动前，RAGFlow 服务已启动

  # 2. 前端 Nginx 服务 (用于托管 Vue 应用)
  frontend:
    build: ./frontend # 使用 frontend 目录下的 Dockerfile 构建镜像
    container_name: kb_frontend
    ports:
      - "8080:80"    # 将主机的 8080 端口映射到容器的 80 端口
    depends_on:
      - backend      # 确保 Nginx 在后端启动后启动

  # 3. PostgreSQL 数据库服务
  db:
    image: postgres:15-alpine
    container_name: kb_database
    volumes:
      - postgres_data:/var/lib/postgresql/data/ # 数据持久化
    env_file:
      - ./backend/.env  # 加载环境变量 (包含数据库密码)
    ports:
      - "5432:5432"

  # 4. RAGFlow AI 引擎服务
  ragflow:
    # 注意: 请参考 RAGFlow 官方文档获取最准确的镜像和配置
    # 这里是一个示例
    image: infiniflow/ragflow:v0.20.5
    container_name: kb_ragflow
    ports:
      - "10000:10000" # 假设 RAGFlow API 端口是 10000
    volumes:
      - ragflow_data:/app/data # RAGFlow 数据持久化

# Docker 数据卷，用于持久化存储
volumes:
  postgres_data:
  ragflow_data: